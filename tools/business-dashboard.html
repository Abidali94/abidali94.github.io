<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>ðŸ“¦ KharchaSaathi â€” Business Dashboard (Stable)</title>
<meta name="theme-color" content="#ff7a00">
<style>
:root{
  --orange:#ff7a00; --orange-dark:#cc6300;
  --bg:#f8f9fa; --card:#fff; --text:#222;
  --dark-bg:#0f0f0f; --dark-card:#1b1b1b; --dark-text:#f2f2f2;
  --dark-border:#444;
}
*{box-sizing:border-box;transition:background .3s,color .3s;}
body{font-family:Poppins,Arial,sans-serif;margin:0;padding:18px;background:var(--bg);color:var(--text);}
body.dark{background:var(--dark-bg);color:var(--dark-text);}
h1{color:var(--orange);}
.topbar{display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;}
.theme-btn,.small-btn,.action-btn{
  background:var(--orange);color:#fff;border:none;
  padding:8px 10px;border-radius:8px;cursor:pointer;transition:.2s;
}
.theme-btn:hover,.small-btn:hover,.action-btn:hover{background:var(--orange-dark);}
.tabs{display:flex;gap:8px;margin:18px 0;justify-content:center;flex-wrap:wrap;}
.tab{background:#eee;padding:8px 12px;border-radius:10px;cursor:pointer;font-weight:600;transition:.2s;}
body.dark .tab{background:#222;color:#ccc;}
.tab.active{background:var(--orange);color:#fff;}
.section{
  display:none;background:var(--card);
  padding:14px;border-radius:12px;
  box-shadow:0 6px 20px rgba(0,0,0,.08);
  margin-bottom:18px;position:relative;z-index:2;
}
.section.active{display:block;}
body.dark .section{
  background:var(--dark-card);
  border:1px solid var(--dark-border);
  box-shadow:0 0 12px rgba(255,255,255,0.05);
  color:var(--dark-text);
}
table{width:100%;border-collapse:collapse;margin-top:12px;}
th,td{padding:8px;border:1px solid #ddd;text-align:center;font-size:13px;}
th{background:var(--orange);color:#fff;}
body.dark th{background:var(--orange-dark);}
body.dark td{border:1px solid var(--dark-border);}
.low{color:#ffbb33;font-weight:700;}
.out{color:#ff5555;font-weight:700;}
.ok{color:#4eff90;font-weight:700;}
.footer-btns{text-align:center;margin-top:20px;}
.footer-btns a{background:var(--orange);color:#fff;padding:10px 16px;border-radius:8px;text-decoration:none;margin:6px;display:inline-block;}
.footer-btns a:hover{background:var(--orange-dark);}
.help-modal{
  position:fixed;top:0;left:0;width:100%;height:100%;
  background:rgba(0,0,0,0.6);display:none;
  justify-content:center;align-items:center;z-index:1000;
}
.help-content{background:var(--card);padding:20px;max-width:550px;border-radius:12px;color:var(--text);overflow-y:auto;max-height:85vh;}
body.dark .help-content{background:var(--dark-card);color:var(--dark-text);}
input, select{
  padding:6px;border:1px solid #ccc;border-radius:6px;
  margin:4px;outline:none;font-size:14px;
}
body.dark input,body.dark select{
  background:#222;color:#fff;border:1px solid var(--dark-border);
}
</style>
</head>
<body>

<div class="topbar">
  <h1>ðŸ“¦ KharchaSaathi (Offline)</h1>
  <button class="theme-btn" id="themeBtn">ðŸŒ™</button>
</div>

<div class="tabs">
  <div class="tab active" data-tab="types">ðŸ—‚ Types</div>
  <div class="tab" data-tab="stock">ðŸ“¦ Stock</div>
  <div class="tab" data-tab="sales">ðŸ“ˆ Sales</div>
  <div class="tab" data-tab="wanting">ðŸ›’ Wanting</div>
</div>
<section id="sales" class="section">
  <h3>ðŸ’° Sales Ledger</h3>
  <label>Sale Date: </label>
  <input type="date" id="saleDate">
  <button class="small-btn" onclick="setSaleDate()">Set Date</button>
  <button class="small-btn" onclick="clearSales()">ðŸ§¹ Clear All</button>
  <table id="salesTable">
    <thead>
      <tr><th>Date</th><th>Type</th><th>Product</th><th>Qty</th><th>Price â‚¹</th><th>Total â‚¹</th><th>Status</th></tr>
    </thead>
    <tbody></tbody>
    <tfoot><tr><td colspan="5" style="text-align:right">Total:</td><td id="dayTotal">0</td><td></td></tr></tfoot>
  </table>
</section>

<!-- Wanting & Footer same as before -->
  <script>
let currentSaleDate = new Date().toISOString().split('T')[0];

function setSaleDate(){
  const d=document.getElementById('saleDate').value;
  if(!d)return alert("Pick a date");
  currentSaleDate=d;
  alert("âœ… Sale date set to "+d);
}

function sellItem(i,status){
  const s=stock[i],remain=s.qty-(s.sold||0);
  if(remain<=0)return alert("No stock left!");
  const qty=parseInt(prompt(`Enter qty (max ${remain})`));
  if(!qty||qty>remain)return;
  const price=parseFloat(prompt("Enter price â‚¹:"));
  if(!price)return;
  const date=currentSaleDate;
  s.sold=(s.sold||0)+qty;
  sales.push({date,type:s.type,product:s.name,qty,price,amount:qty*price,status});
  saveAll();renderStock();renderSales();checkWantAuto(s);
}

function settleCredit(i){
  const s=sales[i];
  if(!s||s.status!=='Credit')return alert("Not a credit sale!");
  if(!confirm(`Settle ${s.product} (${s.amount} â‚¹)?`))return;
  const ex=stock.find(x=>x.type===s.type&&x.name.toLowerCase()===s.product.toLowerCase());
  if(ex){ex.qty+=s.qty;ex.sold-=s.qty;}
  else{stock.push({date:new Date().toISOString().split('T')[0],type:s.type,name:s.product,qty:s.qty,sold:0});}
  sales.splice(i,1);
  saveAll();renderSales();renderStock();
  alert(`âœ… ${s.product} re-added to stock & credit settled`);
}

function renderSales(){
  const tb=document.querySelector('#salesTable tbody');let t=0;
  tb.innerHTML=sales.map((s,i)=>{
    t+=s.amount;
    const btn=s.status==='Credit'?`<button onclick="settleCredit(${i})">âœ… Settle</button>`:'';
    return `<tr><td>${s.date}</td><td>${s.type}</td><td>${s.product}</td>
      <td>${s.qty}</td><td>${s.price}</td><td>${s.amount}</td><td>${s.status} ${btn}</td></tr>`;
  }).join('');
  document.getElementById('dayTotal').textContent=t;
}
</script>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getFirestore, doc, setDoc } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyC1TSwODhcD88-IizbteOGF-bbebAP6Poc",
  authDomain: "kharchasaathi-main.firebaseapp.com",
  projectId: "kharchasaathi-main",
  storageBucket: "kharchasaathi-main.firebasestorage.app",
  messagingSenderId: "116390837159",
  appId: "1:116390837159:web:6e3900fa3b25a07d4c9482",
  measurementId: "G-1M4H9VRSBY"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

async function syncToCloud(){
  try{
    const uid=localStorage.getItem('ks-user')||'guest';
    await setDoc(doc(db,"users",uid,"data","dashboard"),{
      types,stock,sales,want,lastSync:new Date().toLocaleString()
    });
    console.log("âœ… Cloud Sync Successful");
  }catch(err){console.warn("âš ï¸ Cloud Sync Failed:",err.message||err);}
}

window.addEventListener('load',()=>{if(typeof renderAll==='function')renderAll();});
</script>

</body>
</html>
