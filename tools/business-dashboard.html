<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>üì¶ KharchaSaathi ‚Äî Business Dashboard (v4.0 Universal)</title>
  <meta name="theme-color" content="#ff7a00" />
  <link rel="icon" href="/favicon.png" />
  <link rel="apple-touch-icon" href="/favicon.png" />

  <style>
    :root{
      --orange:#ff7a00;
      --orange-dark:#cc6300;
      --bg:#f8f9fa;
      --card:#ffffff;
      --text:#222;
      --dark-bg:#0f0f0f;
      --dark-card:#1a1a1a;
      --dark-text:#f2f2f2;
      --dark-border:#333;
    }

    *{box-sizing:border-box;transition:background .18s,color .18s}
    body{
      margin:0;
      padding:18px;
      font-family:Poppins,Arial,sans-serif;
      background:var(--bg);
      color:var(--text);
    }
    body.dark{
      background:var(--dark-bg);
      color:var(--dark-text);
    }

    /* ---------- TOPBAR ---------- */
    .topbar{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
      margin-bottom:12px
    }
    h1{
      margin:0;
      font-size:20px;
      color:var(--orange)
    }
    #emailTag{
      font-size:13px;
      opacity:.75;
      background:#eee;
      padding:4px 8px;
      border-radius:6px;
    }
    body.dark #emailTag{
      background:#222;
      color:#ddd;
    }

    /* ---------- CLOCK ---------- */
    .simple-clock{
      display:flex;
      flex-direction:column;
      line-height:1.1;
      padding:4px 0;
      min-width:95px;
    }
    .clock-line{
      font-family:monospace;
      font-size:14px;
      font-weight:700;
      color:var(--orange);
    }
    .clock-line.small{
      font-size:11px;
      opacity:0.75;
      color:var(--text);
    }
    body.dark .clock-line.small{
      color:#ddd;
    }

    /* ---------- MAIN TABS ---------- */
    .tabs{
      display:flex;
      gap:8px;
      margin:8px 0 16px;
      justify-content:center;
      flex-wrap:wrap;
    }
    .tab{
      background:#eee;
      padding:8px 12px;
      border-radius:10px;
      cursor:pointer;
      font-weight:600;
      white-space:nowrap
    }
    .tab.active{
      background:var(--orange);
      color:#fff
    }
    body.dark .tab{
      background:#222;
      color:#ccc
    }
    body.dark .tab.active{
      background:var(--orange-dark);
      color:#fff
    }

    /* ---------- SECTIONS ---------- */
    .section{
      display:none;
      background:var(--card);
      padding:14px;
      border-radius:12px;
      box-shadow:0 6px 20px rgba(0,0,0,0.05);
      margin-bottom:18px
    }
    .section.active{display:block}
    body.dark .section{
      background:var(--dark-card);
      border:1px solid var(--dark-border);
    }

    /* ---------- UNIVERSAL MINI TABS (PROFIT / INVESTMENT / COLLECTION) ---------- */
    .u-tabs{
      display:flex;
      gap:8px;
      margin-bottom:12px;
      justify-content:center;
      flex-wrap:wrap;
    }
    .u-btn{
      background:#ff7a00;
      color:white;
      padding:6px 12px;
      border-radius:6px;
      font-size:13px;
      cursor:pointer;
      font-weight:600;
      border:none;
    }
    .u-btn:hover{
      background:#cc6300;
    }

    /* ---------- POPUP ---------- */
    .popup-overlay{
      position:fixed;
      top:0;left:0;
      width:100%;height:100%;
      background:rgba(0,0,0,0.45);
      display:none;
      z-index:9000;
    }
    .popup-box{
      position:fixed;
      top:50%;left:50%;
      transform:translate(-50%,-50%);
      background:var(--card);
      width:90%;
      max-width:350px;
      padding:16px;
      border-radius:12px;
      display:none;
      z-index:9999;
      box-shadow:0 10px 30px rgba(0,0,0,0.4);
    }
    .popup-box h3{
      margin-top:0;
      color:var(--orange);
      text-align:center;
    }
    .sum-line{
      padding:8px;
      background:#fff4e6;
      border-radius:6px;
      margin-bottom:6px;
      font-size:13px;
      font-weight:600;
    }
    .collect-btn{
      width:100%;
      padding:10px;
      border:none;
      background:#2e7d32;
      color:white;
      border-radius:8px;
      font-size:15px;
      cursor:pointer;
      margin-top:10px;
    }
    .collect-btn:hover{
      background:#1b5e20;
    }
  </style>
</head>

<body>

<script>
  const qs  = s => document.querySelector(s);
  const qsa = s => [...document.querySelectorAll(s)];
</script>

<div class="topbar">
  <h1>üì¶ KharchaSaathi</h1>

  <div style="display:flex;align-items:center;gap:10px;">
      <span id="emailTag">Loading...</span>

      <div class="simple-clock">
        <span id="clockTime" class="clock-line">--:--:--</span>
        <span id="clockDate" class="clock-line small">--</span>
      </div>

      <button id="themeBtn" class="u-btn">üåì</button>
      <a href="/index.html" class="u-btn">üè†</a>
  </div>
</div>

<!-- ‚≠ê UNIVERSAL MINI TABS -->
<div class="u-tabs">
  <button id="showProfit" class="u-btn">üí∞ Profit</button>
  <button id="showInvest" class="u-btn">üè¶ Investment</button>
  <button id="showCollect" class="u-btn">ü™ô Collection</button>
</div>
  <div class="tabs">
  <div class="tab active" data-tab="types">üóÇ Types</div>
  <div class="tab" data-tab="stock">üì¶ Stock</div>
  <div class="tab" data-tab="sales">üìà Sales</div>
  <div class="tab" data-tab="wanting">üõí Wanting</div>
  <div class="tab" data-tab="service">üõ† Service</div>
  <div class="tab" data-tab="expenses">üí∏ Expenses</div>
  <div class="tab" data-tab="dashboard">üìä Overview</div>
  <div class="tab" data-tab="collection">ü™ô Collection</div>
</div>

<!-- ========== TYPES ========== -->
<section id="types" class="section active">
  <h3>Item Types</h3>
  <div style="display:flex;gap:8px;margin-top:10px">
    <input id="typeName" placeholder="Add new type" style="flex:1">
    <button id="addTypeBtn" class="u-btn">Add</button>
    <button id="clearTypesBtn" class="u-btn">Clear</button>
  </div>
  <ul id="typeList" style="margin-top:12px;padding-left:18px"></ul>
</section>

<!-- ========== STOCK ========== -->
<section id="stock" class="section">
  <h3>Stock Manager</h3>
  <div style="display:flex;gap:10px;flex-wrap:wrap;margin-bottom:10px">
    <input id="pdate" type="date">
    <select id="ptype"></select>
    <input id="pname" placeholder="Product">
    <input id="pqty" type="number" placeholder="Qty">
    <input id="pcost" type="number" placeholder="Cost">
    <button id="addStockBtn" class="u-btn">Add</button>
  </div>

  <table id="stockTable">
    <thead><tr><th>Date</th><th>Type</th><th>Product</th><th>Qty</th><th>Sold</th><th>Remain</th><th>Action</th></tr></thead>
    <tbody></tbody>
  </table>
</section>

<!-- ========== SALES ========== -->
<section id="sales" class="section">
  <h3>Sales</h3>

  <table id="salesTable">
    <thead><tr><th>Date</th><th>Type</th><th>Product</th><th>Qty</th><th>Price</th><th>Total</th><th>Profit</th><th>Status</th></tr></thead>
    <tbody></tbody>
  </table>
</section>

<!-- ========== WANTING ========== -->
<section id="wanting" class="section">
  <h3>Wanting List</h3>
  <div style="display:flex;gap:10px;margin-bottom:10px;flex-wrap:wrap">
    <select id="wantType"></select>
    <input id="wantName" placeholder="Product">
    <input id="wantNote" placeholder="Note">
    <button id="addWantBtn" class="u-btn">Add</button>
  </div>

  <table id="wantingTable">
    <thead><tr><th>Date</th><th>Type</th><th>Product</th><th>Note</th><th>Action</th></tr></thead>
    <tbody></tbody>
  </table>
</section>

<!-- ========== SERVICE ========== -->
<section id="service" class="section">
  <h3>Service Jobs</h3>

  <table id="svcTable">
    <thead><tr><th>ID</th><th>Date</th><th>Name</th><th>Item</th><th>Problem</th><th>Status</th><th>Action</th></tr></thead>
    <tbody></tbody>
  </table>
</section>

<!-- ========== EXPENSES ========== -->
<section id="expenses" class="section">
  <h3>Expenses</h3>

  <div style="display:flex;gap:8px;margin-bottom:8px;flex-wrap:wrap">
    <input id="expDate" type="date">
    <input id="expCat" placeholder="Category">
    <input id="expAmount" type="number" placeholder="Amount">
    <input id="expNote" placeholder="Note">
    <button id="addExpenseBtn" class="u-btn">Add</button>
  </div>

  <table id="expensesTable">
    <thead><tr><th>Date</th><th>Cat</th><th>Amount</th><th>Note</th><th>Action</th></tr></thead>
    <tbody></tbody>
  </table>
</section>

<!-- ========== OVERVIEW ========== -->
<section id="dashboard" class="section">
  <h3>Business Overview</h3>

  <table>
    <tr><td>Today's Sales</td><td id="todaySales">‚Çπ0</td></tr>
    <tr><td>Today's Expenses</td><td id="todayExpenses">‚Çπ0</td></tr>
    <tr><td>Today's Net Profit</td><td id="todayNet">‚Çπ0</td></tr>
  </table>
</section>

<!-- ========== COLLECTION ========== -->
<section id="collection" class="section">
  <h3>ü™ô Collection Center</h3>

  <table id="collectionHistory">
    <thead><tr><th>Date</th><th>Source</th><th>Details</th><th>Amount</th></tr></thead>
    <tbody></tbody>
  </table>

  <button id="clearCollectionBtn" class="u-btn" style="background:#d32f2f">Clear History</button>
</section>
  
  <!-- POPUP SYSTEM -->
<div id="popOverlay" class="popup-overlay"></div>
<div id="popBox" class="popup-box">
  <div id="popContent"></div>
</div>
  <!-- LIBRARIES -->
<script src="https://cdn.jsdelivr.net/npm/chart.js/dist/chart.umd.min.js"></script>

<!-- AUTO SCRIPT LOADER -->
<script>
(function(){
  const v = Date.now();
  [
    "/js/core.js",
    "/js/firebase.js",
    "/js/types.js",
    "/js/stock.js",
    "/js/sales.js",
    "/js/wanting.js",
    "/js/expenses.js",
    "/js/analytics.js",
    "/js/service.js",
    "/js/collection.js",
    "/js/security.js"
  ].forEach(f=>{
    document.write(`<script src="${f}?v=${v}"><\/script>`);
  });
})();
</script>

<!-- TAB SWITCHER -->
<script>
document.addEventListener("click", e=>{
  if(e.target.classList.contains("tab")){
    const id = e.target.dataset.tab;

    qsa(".section").forEach(s=>s.classList.remove("active"));
    qs("#"+id).classList.add("active");

    qsa(".tab").forEach(t=>t.classList.remove("active"));
    e.target.classList.add("active");

    try{renderCollection();}catch{}
  }
});
</script>

<!-- CLOCK -->
<script>
function updateClock(){
  const d=new Date();
  qs("#clockTime").textContent=d.toLocaleTimeString();
  qs("#clockDate").textContent=d.toLocaleDateString();
}
setInterval(updateClock,1000);
updateClock();
</script>

<!-- UNIVERSAL POPUP LOGIC -->
<script>
const showPop = html=>{
  qs("#popContent").innerHTML=html;
  qs("#popOverlay").style.display="block";
  qs("#popBox").style.display="block";
};
const hidePop = ()=>{
  qs("#popOverlay").style.display="none";
  qs("#popBox").style.display="none";
};
qs("#popOverlay").onclick = hidePop;

/* PROFIT POPUP */
qs("#showProfit").onclick = ()=>{
  const sales = window.getSalesProfitCollected?.() || 0;
  const svc   = window.getServiceProfitCollected?.() || 0;
  const exp   = (window.expenses||[]).reduce((a,b)=>a+Number(b.amount||0),0);
  const net   = sales + svc - exp;

  showPop(`
     <h3>üí∞ Profit</h3>
     <div class="sum-line">Sales Profit: ‚Çπ${sales}</div>
     <div class="sum-line">Service Profit: ‚Çπ${svc}</div>
     <div class="sum-line" style="color:#d32f2f">Expenses: ‚Çπ${exp}</div>
     <div class="sum-line" style="background:#e8f5e9">NET: ‚Çπ${net}</div>
     <button class="collect-btn" onclick="collectProfit(${net})">Collect</button>
  `);
};

function collectProfit(v){
  window.addCollectionEntry("Profit","Net Profit",v);
  hidePop();
  renderCollection?.();
}

/* INVEST POPUP */
qs("#showInvest").onclick = ()=>{
  const s1 = window.getStockInvestmentAfterSale?.() || 0;
  const s2 = window.getServiceInvestmentCollected?.() || 0;
  const t  = s1 + s2;

  showPop(`
    <h3>üè¶ Investment</h3>
    <div class="sum-line">Stock After Sale: ‚Çπ${s1}</div>
    <div class="sum-line">Service Invest: ‚Çπ${s2}</div>
    <div class="sum-line" style="background:#fff8e1">TOTAL: ‚Çπ${t}</div>

    <button class="collect-btn" style="background:#f57f17"
        onclick="collectInvest(${t})">Collect</button>
  `);
};

function collectInvest(v){
  window.addCollectionEntry("Investment","Total Investment",v);
  hidePop();
  renderCollection?.();
}

/* COLLECTION QUICK BUTTON */
qs("#showCollect").onclick = ()=>{
  showPop(`
    <h3>ü™ô Collection</h3>
    <button class="collect-btn" style="background:#1976d2"
      onclick="switchTabToCollection()">Open Collection Center</button>
  `);
}

function switchTabToCollection(){
  hidePop();
  qs("[data-tab='collection']").click();
}
</script>

</body>
</html>
